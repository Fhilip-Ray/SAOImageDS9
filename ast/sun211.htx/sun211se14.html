<!DOCTYPE html> 
<html> 
<head><title>Higher Level Operations on FrameSets</title> 
<meta charset=utf-8/> 
<meta name="generator" content="TeX4ht (http://www.tug.org/tex4ht/)" /> 
<link rel="stylesheet" type="text/css" href="sun211.css" /> 
 <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=MML_HTMLorMML"></script><style type="text/css">.MathJax_MathML {text-indent: 0;}</style></head><body 
>
<div class="crosslinks"><ul class='nav'> <li class="prev"> <a 
href="sun211se13.html" >&#8592Prev</a>&#x00A0;</li> <li class="title">AST<BR>A Library for Handling<BR>World Coordinate Systems<BR>in Astronomy</li> <li class="next"><a 
href="sun211se15.html" >Next&#8594</a>&#x00A0;</li> <li class="toc"><a 
href="sun211.html#toc">TOC &#8593</a></li>
</ul></div>
<h3 class="sectionHead"><span class="titlemark">14    </span> <a 
 id="x15-13300014"></a>Higher Level Operations on FrameSets</h3>
<div class="sectionTOCS">
&#x00A0;<span class="subsectionToc" >14.1 <a 
href="#x15-1340001">Creating FrameSets with astConvert</a></span>
<br />&#x00A0;<span class="subsectionToc" >14.2 <a 
href="#x15-1350002">Converting between FrameSet Coordinate Systems</a></span>
<br />&#x00A0;<span class="subsectionToc" >14.3 <a 
href="#x15-1360003">Example&#x2014;Registering Two Images</a></span>
<br />&#x00A0;<span class="subsectionToc" >14.4 <a 
href="#x15-1370004">Re-Defining a FrameSet Coordinate System</a></span>
<br />&#x00A0;<span class="subsectionToc" >14.5 <a 
href="#x15-1380005">Example&#x2014;Binning an Image</a></span>
<br />&#x00A0;<span class="subsectionToc" >14.6 <a 
href="#x15-1390006">Maintaining the Integrity of FrameSets</a></span>
<br />&#x00A0;<span class="subsectionToc" >14.7 <a 
href="#x15-1400007">Merging FrameSets</a></span>
</div>
<a 
 id="x15-133001r145"></a>
<h4 class="subsectionHead"><span class="titlemark">14.1    </span> <a 
 id="x15-1340001"></a>Creating FrameSets with astConvert</h4>
<!--l. 6930--><p class="noindent" >Before considering the important subject of using FrameSets to convert between coordinate systems
(&#x00A7;<a 
href="#x15-1350002">14.2<!--tex4ht:ref: ss:framesetconverting --></a>), let us return briefly to reconsider the output generated by <a 
href="sun211ss32.html#x57-2490000">astConvert</a>. We used this function
earlier (&#x00A7;<a 
href="sun211se12.html#x13-11500012">12<!--tex4ht:ref: ss:introducingconversion --></a>), when converting between the coordinate systems represented by various kinds of <a 
href="sun211ss452.html#x479-6710000">Frame</a>,
and indicated that it returns a <a 
href="sun211ss453.html#x480-6720000">FrameSet</a> to represent the coordinate conversion it identifies. We are
now in a position to examine the structure of this FrameSet.
<!--l. 6939--><p class="noindent" >Take our earlier example (&#x00A7;<a 
href="sun211se12.html#x13-1160001">12.1<!--tex4ht:ref: ss:convertingskyframes --></a>) of converting between the celestial coordinate systems represented by
two SkyFrames:
<div class="fancyvrb" id="fancyvrb150"> <a 
 id="x15-134002r1"></a>&#x00A0;&#x00A0;#include&#x00A0;&#x0022;ast.h&#x0022;<br class="fancyvrb" /><a 
 id="x15-134004r2"></a>&#x00A0;&#x00A0;AstFrameSet&#x00A0;*cvt;<br class="fancyvrb" /><a 
 id="x15-134006r3"></a>&#x00A0;&#x00A0;AstSkyFrame&#x00A0;*skyframe1,&#x00A0;*skyframe2;<br class="fancyvrb" /><a 
 id="x15-134008r4"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x15-134010r5"></a>&#x00A0;&#x00A0;...<br class="fancyvrb" /><a 
 id="x15-134012r6"></a>&#x00A0;&#x00A0;
<br class="fancyvrb" /><a 
 id="x15-134014r7"></a>&#x00A0;&#x00A0;skyframe1&#x00A0;=&#x00A0;astSkyFrame(&#x00A0;&#x0022;System=FK4-NO-E,&#x00A0;Epoch=B1958,&#x00A0;Equinox=B1960&#x0022;&#x00A0;);
<br class="fancyvrb" /><a 
 id="x15-134016r8"></a>&#x00A0;&#x00A0;skyframe2&#x00A0;=&#x00A0;astSkyFrame(&#x00A0;&#x0022;System=Ecliptic,&#x00A0;Equinox=J2010.5&#x0022;&#x00A0;);<br class="fancyvrb" /><a 
 id="x15-134018r9"></a>&#x00A0;&#x00A0;
<br class="fancyvrb" /><a 
 id="x15-134020r10"></a>&#x00A0;&#x00A0;cvt&#x00A0;=&#x00A0;astConvert(&#x00A0;skyframe1,&#x00A0;skyframe2,&#x00A0;&#x0022;&#x0022;&#x00A0;);</div>
<!--l. 6958--><p class="noindent" >This will produce a pointer, &#x201C;cvt&#x201D;, to the FrameSet shown in Figure&#x00A0;<a 
href="#x15-13402112">12<!--tex4ht:ref: fig:fsconvert --></a>. <hr class="figure"><div class="figure" 
>
                                                                                       

                                                                                       
<a 
 id="x15-13402112"></a>
                                                                                       

                                                                                       
<div class="center">
<img 
src="sun211_figures/fsconvert.png" alt="pdfpict"  
 width="70%" >
<br /> <div class="caption" 
><span class="id">Figure&#x00A0;12: </span><span  
class="content">The FrameSet produced when astConvert is used to convert between the coordinate
systems represented by two SkyFrames. The source <a 
href="sun211ss478.html#x505-6970000">SkyFrame</a> becomes the base Frame, while
the destination SkyFrame becomes the current Frame. The <a 
href="sun211ss459.html#x486-6780000">Mapping</a> between them implements
the required conversion.</span></div><!--tex4ht:label?: x15-13402112 -->
</div>
                                                                                       

                                                                                       
<!--l. 6970--><p class="noindent" ></div><hr class="endfigure">
<!--l. 6972--><p class="noindent" >As can be seen, this FrameSet contains just two Frames. The source Frame supplied to astConvert
becomes its base Frame, while the destination Frame becomes its current Frame. (The FrameSet, of
course, simply holds pointers to these Frames, rather than making copies.) The Mapping which
relates the base Frame to the current Frame is the one which implements the required
conversion.
<!--l. 6979--><p class="noindent" >As we noted earlier (&#x00A7;<a 
href="sun211se12.html#x13-1160001">12.1<!--tex4ht:ref: ss:convertingskyframes --></a>), the FrameSet returned by astConvert may be used both as a
Mapping and as a Frame to perform most of the functions you are likely to need. However, the
Mapping may be extracted for use on its own if necessary, using <a 
href="sun211ss67.html#x92-2840000">astGetMapping</a> (&#x00A7;<a 
href="sun211se13.html#x14-1290007">13.7<!--tex4ht:ref: ss:extractingamapping --></a>), for
example:
<div class="fancyvrb" id="fancyvrb151"> <a 
 id="x15-134023r1"></a>&#x00A0;&#x00A0;AstMapping&#x00A0;*mapping;<br class="fancyvrb" /><a 
 id="x15-134025r2"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x15-134027r3"></a>&#x00A0;&#x00A0;...<br class="fancyvrb" /><a 
 id="x15-134029r4"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x15-134031r5"></a>&#x00A0;&#x00A0;mapping&#x00A0;=&#x00A0;astGetMapping(&#x00A0;cvt,&#x00A0;AST__BASE,&#x00A0;AST__CURRENT&#x00A0;);</div>
<a 
 id="x15-134032r147"></a>
<h4 class="subsectionHead"><span class="titlemark">14.2    </span> <a 
 id="x15-1350002"></a>Converting between FrameSet Coordinate Systems</h4>
<!--l. 6997--><p class="noindent" >We now consider the process of converting between the coordinate systems represented by two
FrameSets. This is a most important operation, as a subsequent example (&#x00A7;<a 
href="#x15-1360003">14.3<!--tex4ht:ref: ss:registeringimages --></a>) will show, and is
illustrated in Figure&#x00A0;<a 
href="#x15-13500113">13<!--tex4ht:ref: fig:fsalign --></a>. <hr class="figure"><div class="figure" 
>
                                                                                       

                                                                                       
<a 
 id="x15-13500113"></a>
                                                                                       

                                                                                       
<div class="center">
<img 
src="sun211_figures/fsalign.png" alt="pdfpict"  
 width="70%" >
<br /> <div class="caption" 
><span class="id">Figure&#x00A0;13: </span><span  
class="content">Conversion between two FrameSets is performed by establishing a link between a
pair of Frames, one from each <a 
href="sun211ss453.html#x480-6720000">FrameSet</a>. If conversion between these two Frames is possible,
then a route for converting between the current Frames of both FrameSets can also be found. In
practice, there may be many ways of pairing Frames to find the &#x201C;missing link&#x201D;, so the Frames&#x2019;
<a 
href="sun211ss279.html#x305-4970000">Domain</a> attribute may be used to narrow the choice.</span></div><!--tex4ht:label?: x15-13500113 -->
</div>
                                                                                       

                                                                                       
<!--l. 7014--><p class="noindent" ></div><hr class="endfigure">
<!--l. 7016--><p class="noindent" >Recalling (&#x00A7;<a 
href="sun211se13.html#x14-1300008">13.8<!--tex4ht:ref: ss:framesetasframe --></a>) that a FrameSet will behave like its current <a 
href="sun211ss452.html#x479-6710000">Frame</a> when necessary, conversion
between two FrameSets is performed using <a 
href="sun211ss32.html#x57-2490000">astConvert</a> (&#x00A7;<a 
href="sun211se12.html#x13-1160001">12.1<!--tex4ht:ref: ss:convertingskyframes --></a>), but supplying pointers to FrameSets
instead of Frames. The effect of this is to convert between the coordinate systems represented by the
current Frames of each FrameSet:
<div class="fancyvrb" id="fancyvrb152"> <a 
 id="x15-135003r1"></a>&#x00A0;&#x00A0;AstFrameSet&#x00A0;*frameseta,&#x00A0;*framesetb;<br class="fancyvrb" /><a 
 id="x15-135005r2"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x15-135007r3"></a>&#x00A0;&#x00A0;...<br class="fancyvrb" /><a 
 id="x15-135009r4"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x15-135011r5"></a>&#x00A0;&#x00A0;cvt&#x00A0;=&#x00A0;astConvert(&#x00A0;frameseta,&#x00A0;framesetb,&#x00A0;&#x0022;SKY&#x0022;&#x00A0;);</div>
<!--l. 7033--><p class="noindent" >When using FrameSets, we are presented with considerably more conversion options than when using
Frames alone. This is because each current Frame is related to all the other Frames in its
respective FrameSet. Therefore, if we can establish a link between any pair of Frames, one from
each FrameSet, we can form a complete conversion path between the two current Frames
(Figure&#x00A0;<a 
href="#x15-13500113">13<!--tex4ht:ref: fig:fsalign --></a>).
<!--l. 7040--><p class="noindent" >This expanded range of options is, of course, precisely the intention. By connecting Frames together
within a FrameSet, we have extended the range of coordinate systems that can be reached from any
one of them. We are therefore no longer restricted to converting between Frames with the same
Domain value (&#x00A7;<a 
href="sun211se7.html#x8-8500012">7.12<!--tex4ht:ref: ss:framedomains --></a>), but can go <em>via</em> a range of intermediate coordinate systems in order to make the
connection we require. Transformation between different domains has therefore become possible
because, in assembling the FrameSets, we provided the additional information needed to inter-relate
them.
<!--l. 7051--><p class="noindent" >It is important to appreciate, however, that the choice of &#x201C;missing link&#x201D; is crucial in determining the
conversion that results. Although each FrameSet may be perfectly self-consistent internally, this does
not mean that all conversion paths through the combined network of Mappings are equivalent. Quite
the contrary in fact: everything depends on where the inter-connecting link between the two
FrameSets is made. In practice, there may be a large number of possible pairings of Frames and
hence of possible links. Other factors must therefore be used to restrict the choice. These
are:
     <dl class="enumerate-enumitem"><dt class="enumerate-enumitem">
  (1) </dt><dd 
class="enumerate-enumitem">Not  every  possible  pairing  of  Frames  is  legitimate.  For  example,  you  cannot  convert
     directly between a basic Frame and a <a 
href="sun211ss478.html#x505-6970000">SkyFrame</a> which belong to different classes, so such
     pairings will be ignored.
     </dd><dt class="enumerate-enumitem">
  (2) </dt><dd 
class="enumerate-enumitem">In  a  similar  way,  you  cannot  convert  directly  between  Frames  with  different  Domain
     values (&#x00A7;<a 
href="sun211se7.html#x8-8500012">7.12<!--tex4ht:ref: ss:framedomains --></a>). If the Domain attribute is used consistently (typically only one Frame in
     each FrameSet will have a particular Domain value), then this further restricts the choice.
     </dd><dt class="enumerate-enumitem">
  (3) </dt><dd 
class="enumerate-enumitem">The third argument of astConvert may then be used to specify explicitly which Domain
     value the paired Frames should have. You may also supply a comma-separated list of
     preferences here (see below).
     </dd><dt class="enumerate-enumitem">
  (4) </dt><dd 
class="enumerate-enumitem">If the above steps fail to uniquely identify the link, then the first suitable pairing of Frames
     is used, so that any ambiguity is resolved by the order in which Frames are considered for
     pairing (see the description of the astConvert function in Appendix&#x00A0;<a 
href="sun211se24.html#x25-2170002">B<!--tex4ht:ref: ss:functiondescriptions --></a> for details of the
     search order).<span class="footnote-mark"><a 
href="#fn22x0" id="fn22x0-bk"><sup class="textsuperscript">22</sup></a></span><a 
 id="x15-135016f22"></a></dd></dl>
                                                                                       

                                                                                       
<!--l. 7089--><p class="noindent" >In the example above we supplied the string &#x201C;SKY&#x201D; as the third argument of astConvert. This
constitutes a request that a pair of Frames with the Domain value SKY (<em>i.e.</em>&#x00A0;representing celestial
coordinate systems) should be used to inter-relate the two FrameSets. Note that this does not specify
which celestial coordinate system to use, but is a general request that the two FrameSets be
inter-related using coordinates on the celestial sphere.
<!--l. 7098--><p class="noindent" >Of course, it may be that this request cannot be met because there may not be a celestial coordinate
system in both FrameSets. If this is likely to happen, we can supply a list of preferences, or a <em>domain
search path</em>, as the third argument to astConvert, such as the following:
<div class="fancyvrb" id="fancyvrb153"> <a 
 id="x15-135018r1"></a>&#x00A0;&#x00A0;cvt&#x00A0;=&#x00A0;astConvert(&#x00A0;frameseta,&#x00A0;framesetb,&#x00A0;&#x0022;SKY,PIXEL,GRID,&#x0022;&#x00A0;);</div>
<!--l. 7111--><p class="noindent" >Now, if the two FrameSets cannot be inter-related using the SKY domain, astConvert will attempt to
use the PIXEL domain instead. If this also fails, it will try the GRID domain. A blank field in the
domain search path (here indicated by the final comma) allows any Domain value to be used. This can
be employed as a last resort when all else has failed.
<!--l. 7118--><p class="noindent" >If astConvert succeeds in identifying a conversion, it will return a pointer to a FrameSet
(&#x00A7;<a 
href="#x15-1340001">14.1<!--tex4ht:ref: ss:framesetsfromconvert --></a>) in which the source and destination Frames are inter-connected by the required
Mapping. In this case, of course, these Frames will be the current Frames of the two FrameSets,
but in all other respects the returned FrameSet is the same as when converting between
Frames.
<!--l. 7125--><p class="noindent" >Very importantly, however, astConvert may modify the FrameSets you are converting between. It
does this, in order to indicate which pairing of Frames was used to inter-relate them, by changing the
<a 
href="sun211ss252.html#x278-4700000">Base</a> attribute for each FrameSet so that the Frame used in the pairing becomes its base Frame
(&#x00A7;<a 
href="sun211se13.html#x14-1260004">13.4<!--tex4ht:ref: ss:baseandcurrent --></a>).
<!--l. 7131--><p class="noindent" >Finally, note that astConvert may also be used to convert between a FrameSet and a Frame, or <em>vice
versa</em>. If a pointer to a Frame is supplied for either the first or second argument, it will behave like a
FrameSet containing only a single Frame.
<a 
 id="x15-135019r149"></a>
<h4 class="subsectionHead"><span class="titlemark">14.3    </span> <a 
 id="x15-1360003"></a>Example&#x2014;Registering Two Images</h4>
<!--l. 7138--><p class="noindent" >Consider two images which have been calibrated by attaching FrameSets to them, such that
the base <a 
href="sun211ss452.html#x479-6710000">Frame</a> of each <a 
href="sun211ss453.html#x480-6720000">FrameSet</a> corresponds to the raw data grid coordinates of each
image (the GRID domain of &#x00A7;<a 
href="sun211se7.html#x8-8600013">7.13<!--tex4ht:ref: ss:domainconventions --></a>). Suppose, also, that these FrameSets contain an unknown
number of other Frames, representing alternative world coordinate systems. What we wish to
do is register these two images, such that we can transform from a position in the data
grid of one into the corresponding position in the data grid of the other. This is a very
practical example because images will typically be calibrated using FrameSets in precisely this
way.
<!--l. 7149--><p class="noindent" >The first step will probably involve making a copy of both FrameSets (using <a 
href="sun211ss34.html#x59-2510000">astCopy</a>&#x2014;&#x00A7;<a 
href="sun211se4.html#x5-4900013">4.13<!--tex4ht:ref: ss:copyingobjects --></a>), since
we will be modifying them. Let &#x201C;frameseta&#x201D; and &#x201C;framesetb&#x201D; be pointers to these copies.
Since we want to convert between the base Frames of these FrameSets (<em>i.e.</em>&#x00A0;their data grid
coordinates), the next step is to make these Frames current. This is simply done by inverting both
FrameSets, which interchanges their base and current Frames. <a 
href="sun211ss94.html#x119-3110000">astInvert</a> will perform this
task:
<div class="fancyvrb" id="fancyvrb154"> <a 
 id="x15-136002r1"></a>&#x00A0;&#x00A0;astInvert(&#x00A0;frameseta&#x00A0;);<br class="fancyvrb" /><a 
 id="x15-136004r2"></a>&#x00A0;&#x00A0;astInvert(&#x00A0;framesetb&#x00A0;);</div>
                                                                                       

                                                                                       
<!--l. 7165--><p class="noindent" >To identify the required conversion, we now use <a 
href="sun211ss32.html#x57-2490000">astConvert</a>, supplying a suitable domain search path
with which we would like our two images to be registered:
<div class="fancyvrb" id="fancyvrb155"> <a 
 id="x15-136006r1"></a>&#x00A0;&#x00A0;cvt&#x00A0;=&#x00A0;astConvert(&#x00A0;frameseta,&#x00A0;framesetb,&#x00A0;&#x0022;SKY,PIXEL,GRID&#x0022;&#x00A0;);<br class="fancyvrb" /><a 
 id="x15-136008r2"></a>&#x00A0;&#x00A0;if&#x00A0;(&#x00A0;cvt&#x00A0;==&#x00A0;AST__NULL&#x00A0;)&#x00A0;{
<br class="fancyvrb" /><a 
 id="x15-136010r3"></a>&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x003C;no&#x00A0;conversion&#x00A0;was&#x00A0;possible&#x003E;<br class="fancyvrb" /><a 
 id="x15-136012r4"></a>&#x00A0;&#x00A0;}&#x00A0;else&#x00A0;{<br class="fancyvrb" /><a 
 id="x15-136014r5"></a>&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x003C;conversion&#x00A0;was&#x00A0;possible&#x003E;<br class="fancyvrb" /><a 
 id="x15-136016r6"></a>&#x00A0;&#x00A0;}</div>
<!--l. 7180--><p class="noindent" >The effects of this are:
     <dl class="enumerate-enumitem"><dt class="enumerate-enumitem">
  (1) </dt><dd 
class="enumerate-enumitem">astConvert  first  attempts  to  register  the  two  images  on  the  celestial  sphere  (<em>i.e.</em>&#x00A0;using
     the SKY domain). To do this, it searches for a celestial coordinate system, although not
     necessarily the same one, attached to each image. If it finds a suitable pair of coordinate
     systems, it then registers the images by matching corresponding positions on the sky.
     </dd><dt class="enumerate-enumitem">
  (2) </dt><dd 
class="enumerate-enumitem">If  this  fails,  astConvert  next  tries  to  match  positions  in  the  PIXEL  domain  (&#x00A7;<a 
href="sun211se7.html#x8-8500012">7.12<!--tex4ht:ref: ss:framedomains --></a>).  If
     it  succeeds,  the  two  images  will  then  be  registered  so  that  their  corresponding  pixel
     positions  correspond.  If  the  PIXEL  domain  is  offset  from  the  data  grid  (as  typically
     happens in data reduction systems which implement a &#x201C;pixel origin&#x201D;), then this will be
     correctly accounted for.
     </dd><dt class="enumerate-enumitem">
  (3) </dt><dd 
class="enumerate-enumitem">If this also fails, the GRID domain is finally used. This will result in image registration by
     matching corresponding points in the data grids used by both images. This means they
     will be aligned so that the first element their data arrays correspond.
     </dd><dt class="enumerate-enumitem">
  (4) </dt><dd 
class="enumerate-enumitem">If all of the above fail, astConvert will return the value AST__NULL. Otherwise a pointer
     to a FrameSet will be returned.</dd></dl>
<!--l. 7206--><p class="noindent" >The resulting &#x201C;cvt&#x201D; FrameSet may then be used directly (&#x00A7;<a 
href="sun211se12.html#x13-1160001">12.1<!--tex4ht:ref: ss:convertingskyframes --></a>) to convert between positions in the
data grid of the first image and corresponding positions in the data grid of the second
image.
<!--l. 7211--><p class="noindent" >To determine which domain was used to achieve registration, we can use the fact that the <a 
href="sun211ss252.html#x278-4700000">Base</a>
attribute of each FrameSet is set by astConvert to indicate which intermediate Frames were used. We
can therefore simply invert either FrameSet (to make its base Frame become the current one) and then
enquire the <a 
href="sun211ss279.html#x305-4970000">Domain</a> value:
<div class="fancyvrb" id="fancyvrb156"> <a 
 id="x15-136022r1"></a>&#x00A0;&#x00A0;const&#x00A0;char&#x00A0;*domain;<br class="fancyvrb" /><a 
 id="x15-136024r2"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x15-136026r3"></a>&#x00A0;&#x00A0;...<br class="fancyvrb" /><a 
 id="x15-136028r4"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x15-136030r5"></a>&#x00A0;&#x00A0;astInvert(&#x00A0;frameseta&#x00A0;);<br class="fancyvrb" /><a 
 id="x15-136032r6"></a>&#x00A0;&#x00A0;domain&#x00A0;=&#x00A0;astGetC(&#x00A0;frameseta,&#x00A0;&#x0022;Domain&#x0022;&#x00A0;);</div>
<!--l. 7228--><p class="noindent" >If conversion was successful, the result will be one of the strings &#x201C;SKY&#x201D;, &#x201C;PIXEL&#x201D; or &#x201C;GRID&#x201D;.
<a 
 id="x15-136033r151"></a>
                                                                                       

                                                                                       
<h4 class="subsectionHead"><span class="titlemark">14.4    </span> <a 
 id="x15-1370004"></a>Re-Defining a FrameSet Coordinate System</h4>
<!--l. 7233--><p class="noindent" >As discussed earlier (&#x00A7;<a 
href="sun211se13.html#x14-1260004">13.4<!--tex4ht:ref: ss:baseandcurrent --></a>), an important application of a <a 
href="sun211ss453.html#x480-6720000">FrameSet</a> is to allow coordinate system
information to be attached to entities such as images in order to calibrate them. In addition, one of
the main objectives of AST is to simplify the propagation of such information through
successive stages of data processing, so that it remains consistent with the associated image
data.
<!--l. 7241--><p class="noindent" >In such a situation, the FrameSet&#x2019;s base <a 
href="sun211ss452.html#x479-6710000">Frame</a> would correspond with the image&#x2019;s data grid
coordinates and its other Frames (if any) with the various alternative world coordinate systems
associated with the image. If the data processing being performed does not change the relationship
between the image&#x2019;s data grid coordinates and any of the associated world coordinate systems, then
propagation of the WCS information is straightforward and simply involves copying the FrameSet
associated with the image.
<!--l. 7250--><p class="noindent" >If any of these relationships change, however, then corresponding changes must be made to the way
Frames within the FrameSet are inter-related. By far the most common case occurs when
the image undergoes some geometrical transformation resulting in &#x201C;re-gridding&#x201D; on to
another data grid, but the same principles can be applied to any re-definition of a coordinate
system.
<!--l. 7257--><p class="noindent" >To pursue the re-gridding example, we would need to modify our FrameSet to account for the fact
that the image&#x2019;s data grid coordinate system (corresponding to the FrameSet&#x2019;s base Frame) has
changed. Looking at the steps needed in detail, we might proceed as follows:
     <dl class="enumerate-enumitem"><dt class="enumerate-enumitem">
  (1) </dt><dd 
class="enumerate-enumitem">Create  a  <a 
href="sun211ss459.html#x486-6780000">Mapping</a>  which  represents  the  relationship  between  the  original  data  grid
     coordinate system and the new one.
     </dd><dt class="enumerate-enumitem">
  (2) </dt><dd 
class="enumerate-enumitem">Obtain a Frame to represent the new data grid coordinate system (we could re-use the
     original base Frame here, using <a 
href="sun211ss65.html#x90-2820000">astGetFrame</a> to obtain a pointer to it).
     </dd><dt class="enumerate-enumitem">
  (3) </dt><dd 
class="enumerate-enumitem">Add  the  new  Frame  to  the  FrameSet,  related  to  the  original  base  Frame  by  the  new
     Mapping. This Frame now represents the new data grid coordinate system and is correctly
     related to all the other Frames present.<span class="footnote-mark"><a 
href="#fn23x0" id="fn23x0-bk"><sup class="textsuperscript">23</sup></a></span><a 
 id="x15-137004f23"></a>
     </dd><dt class="enumerate-enumitem">
  (4) </dt><dd 
class="enumerate-enumitem">Remove the original base Frame (representing the old data grid coordinate system).
     </dd><dt class="enumerate-enumitem">
  (5) </dt><dd 
class="enumerate-enumitem">Make the new Frame the base Frame and restore the original current Frame.</dd></dl>
<!--l. 7286--><p class="noindent" >The effect of these steps is to change the relationship between the base Frame and all the other Frames
present. It is as if a new Mapping has been interposed between the Frame we want to alter and all the
other Frames within the FrameSet (Figure&#x00A0;<a 
href="#x15-13700714">14<!--tex4ht:ref: fig:fsremap --></a>). <hr class="figure"><div class="figure" 
>
                                                                                       

                                                                                       
<a 
 id="x15-13700714"></a>
                                                                                       

                                                                                       
<div class="center">
<img 
src="sun211_figures/fsremap.png" alt="pdfpict"  
 width="70%" >
<br /> <div class="caption" 
><span class="id">Figure&#x00A0;14: </span><span  
class="content">The effect of <a 
href="sun211ss165.html#x190-3820000">astRemapFrame</a> is to interpose a Mapping between a nominated Frame
within a FrameSet and the remaining contents of the FrameSet. This effectively &#x201C;re-defines&#x201D; the
coordinate system represented by the affected Frame. It may be used to compensate (say) for
geometrical changes made to an associated image. The inter-relationships between all the other
Frames within the FrameSet remain unchanged.</span></div><!--tex4ht:label?: x15-13700714 -->
</div>
                                                                                       

                                                                                       
<!--l. 7303--><p class="noindent" ></div><hr class="endfigure">
<!--l. 7305--><p class="noindent" >Performing the steps above is rather lengthy, however, so the astRemapFrame function is provided to
perform all of these operations in one go. A practical example of its use is given below
(&#x00A7;<a 
href="#x15-1380005">14.5<!--tex4ht:ref: ss:wcsprocessingexample --></a>).
<a 
 id="x15-137008r152"></a>
<h4 class="subsectionHead"><span class="titlemark">14.5    </span> <a 
 id="x15-1380005"></a>Example&#x2014;Binning an Image</h4>
<!--l. 7312--><p class="noindent" >As an example of using <a 
href="sun211ss165.html#x190-3820000">astRemapFrame</a>, consider a case where the pixels of a 2-dimensional image have been
binned 2<!--l. 7313--><math 
 xmlns="http://www.w3.org/1998/Math/MathML"  
display="inline" ><mo 
class="MathClass-bin">&#x00D7;</mo></math>2,
so as to reduce the image size by a factor of two in each dimension. We must now modify the
associated <a 
href="sun211ss453.html#x480-6720000">FrameSet</a> to reflect this change to the image. Much the same process would be needed for
any other geometrical change the image might undergo.
<!--l. 7319--><p class="noindent" >We first set up a <a 
href="sun211ss459.html#x486-6780000">Mapping</a> (a <a 
href="sun211ss498.html#x525-7170000">WinMap</a> in this case) which relates the data grid coordinates in the
original image to those in the new one:
<div class="fancyvrb" id="fancyvrb157"> <a 
 id="x15-138002r1"></a>&#x00A0;&#x00A0;AstWinMap&#x00A0;*winmap;<br class="fancyvrb" /><a 
 id="x15-138004r2"></a>&#x00A0;&#x00A0;double&#x00A0;ina[&#x00A0;2&#x00A0;]&#x00A0;=&#x00A0;{&#x00A0;0.5,&#x00A0;0.5&#x00A0;};<br class="fancyvrb" /><a 
 id="x15-138006r3"></a>&#x00A0;&#x00A0;double&#x00A0;inb[&#x00A0;2&#x00A0;]&#x00A0;=&#x00A0;{&#x00A0;2.5,&#x00A0;2.5&#x00A0;};
<br class="fancyvrb" /><a 
 id="x15-138008r4"></a>&#x00A0;&#x00A0;double&#x00A0;outa[&#x00A0;2&#x00A0;]&#x00A0;=&#x00A0;{&#x00A0;0.5,&#x00A0;0.5&#x00A0;};<br class="fancyvrb" /><a 
 id="x15-138010r5"></a>&#x00A0;&#x00A0;double&#x00A0;outb[&#x00A0;2&#x00A0;]&#x00A0;=&#x00A0;{&#x00A0;1.5,&#x00A0;1.5&#x00A0;};<br class="fancyvrb" /><a 
 id="x15-138012r6"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x15-138014r7"></a>&#x00A0;&#x00A0;...<br class="fancyvrb" /><a 
 id="x15-138016r8"></a>&#x00A0;&#x00A0;
<br class="fancyvrb" /><a 
 id="x15-138018r9"></a>&#x00A0;&#x00A0;winmap&#x00A0;=&#x00A0;astWinMap(&#x00A0;2,&#x00A0;ina,&#x00A0;inb,&#x00A0;outa,&#x00A0;outb,&#x00A0;&#x0022;&#x0022;&#x00A0;);</div>
<!--l. 7336--><p class="noindent" >Here, we have simply set up arrays containing the data grid coordinates of the bottom left
and top right corners of the first element in the output image (&#x201C;outa&#x201D; and &#x201C;outb&#x201D;) and the
corresponding coordinates in the input image (&#x201C;ina&#x201D; and &#x201C;inb&#x201D;). <a 
href="sun211ss236.html#x261-4530000">astWinMap</a> then creates a
WinMap which performs the required transformation. We do not need to know the size of the
image.
<!--l. 7343--><p class="noindent" >We can then pass this WinMap to astRemapFrame. This modifies the relationship between our
FrameSet&#x2019;s base <a 
href="sun211ss452.html#x479-6710000">Frame</a> and the other Frames in the FrameSet, so that the base Frame represents the
data grid coordinate system of the new image rather than the old one:
<div class="fancyvrb" id="fancyvrb158"> <a 
 id="x15-138020r1"></a>&#x00A0;&#x00A0;AstFrameSet&#x00A0;*frameset;<br class="fancyvrb" /><a 
 id="x15-138022r2"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x15-138024r3"></a>&#x00A0;&#x00A0;...<br class="fancyvrb" /><a 
 id="x15-138026r4"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x15-138028r5"></a>&#x00A0;&#x00A0;astRemapFrame(&#x00A0;frameset,&#x00A0;AST__BASE,&#x00A0;winmap&#x00A0;);</div>
<!--l. 7358--><p class="noindent" >Any other coordinate systems described by the FrameSet, no matter how many of these there might
be, are now correctly associated with the new image.
<a 
 id="x15-138029r154"></a>
<h4 class="subsectionHead"><span class="titlemark">14.6    </span> <a 
 id="x15-1390006"></a>Maintaining the Integrity of FrameSets</h4>
<!--l. 7364--><p class="noindent" >When constructing a <a 
href="sun211ss453.html#x480-6720000">FrameSet</a>, you are provided with a framework into which you can place any
combination of Frames and Mappings that you wish. There are relatively few constraints on this
process and no checks are performed to see whether the FrameSet you construct makes physical sense.
It is quite possible, for example, to construct a FrameSet containing two identical SkyFrames which
are inter-related by a non-unit <a 
href="sun211ss459.html#x486-6780000">Mapping</a>. AST will not object if you do this, but it makes no sense,
because applying a non-unit Mapping to any set of celestial coordinates cannot yield positions that are
still in the original coordinate system. If you use such a FrameSet to perform coordinate
conversions, you are likely to get unpredictable results because the information in the FrameSet is
corrupt.
                                                                                       

                                                                                       
<!--l. 7377--><p class="noindent" >It is, of course, your responsibility as a programmer to ensure the validity of any information which
you insert into a FrameSet. Normally, this is straightforward and simply consists of formulating
your problem correctly (a diagram can often help to clarify how coordinate systems are
inter-related) and writing the appropriate bug-free code to construct the FrameSet. However,
once you start to modify an existing FrameSet, there are new opportunities for corrupting
it!
<!--l. 7386--><p class="noindent" >Consider, for example, a FrameSet whose current <a 
href="sun211ss452.html#x479-6710000">Frame</a> is a <a 
href="sun211ss478.html#x505-6970000">SkyFrame</a>. We can set a new
value for this SkyFrame&#x2019;s <a 
href="sun211ss286.html#x312-5040000">Equinox</a> attribute simply by using <a 
href="sun211ss177.html#x202-3940000">astSet</a> on the FrameSet, as
follows:
<div class="fancyvrb" id="fancyvrb159"> <a 
 id="x15-139002r1"></a>&#x00A0;&#x00A0;astSet(&#x00A0;frameset,&#x00A0;&#x0022;Equinox=J2010&#x0022;&#x00A0;);</div>
<!--l. 7396--><p class="noindent" >The effect of this will be to change the celestial coordinate system which the current Frame represents.
You can see, however, that this has the potential to make the FrameSet corrupt unless corresponding
changes are also made to the Mapping which relates this SkyFrame to the other Frames within the
FrameSet. In fact, it is a general rule that any change to a FrameSet which affects its current Frame can
potentially require corresponding changes to the FrameSet&#x2019;s Mappings in order to maintain its overall
integrity.
<!--l. 7405--><p class="noindent" >Fortunately, once you have stored valid information in a FrameSet, AST will look after these details
for you automatically, so that the FrameSet&#x2019;s integrity is maintained. In the example above, it would
do this by appropriately re-mapping the current Frame (as if <a 
href="sun211ss165.html#x190-3820000">astRemapFrame</a> had been
used&#x2014;&#x00A7;<a 
href="#x15-1370004">14.4<!--tex4ht:ref: ss:remapframe --></a>) in response to the use of astSet. One way of illustrating this process is as
follows:
<div class="fancyvrb" id="fancyvrb160"> <a 
 id="x15-139004r1"></a>&#x00A0;&#x00A0;AstSkyFrame&#x00A0;*skyframe;<br class="fancyvrb" /><a 
 id="x15-139006r2"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x15-139008r3"></a>&#x00A0;&#x00A0;...<br class="fancyvrb" /><a 
 id="x15-139010r4"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x15-139012r5"></a>&#x00A0;&#x00A0;skyframe&#x00A0;=&#x00A0;astSkyFrame(&#x00A0;&#x0022;&#x0022;&#x00A0;);
<br class="fancyvrb" /><a 
 id="x15-139014r6"></a>&#x00A0;&#x00A0;frameSet&#x00A0;=&#x00A0;astFrameSet(&#x00A0;skyframe&#x00A0;);<br class="fancyvrb" /><a 
 id="x15-139016r7"></a>&#x00A0;&#x00A0;astAddFrame(&#x00A0;frameset,&#x00A0;1,&#x00A0;astUnitMap(&#x00A0;2,&#x00A0;&#x0022;&#x0022;&#x00A0;),&#x00A0;skyframe&#x00A0;);</div>
<!--l. 7424--><p class="noindent" >This constructs a trivial FrameSet whose base and current Frames are both the same SkyFrame
connected by a <a 
href="sun211ss495.html#x522-7140000">UnitMap</a>. You can think of this as a &#x201C;pipe&#x201D; connecting two coordinate systems. At
present, these two systems represent identical ICRS coordinates, so the FrameSet implements a
unit Mapping. We can change the coordinate system on the current end of this pipe as
follows:
<div class="fancyvrb" id="fancyvrb161"> <a 
 id="x15-139018r1"></a>&#x00A0;&#x00A0;astSet(&#x00A0;frameset,&#x00A0;&#x0022;System=Ecliptic,&#x00A0;Equinox=J2010&#x0022;&#x00A0;);</div>
<!--l. 7437--><p class="noindent" >and the Mapping which the FrameSet implements would change accordingly. To change the
coordinate system on the base end of the pipe, we might use:
<div class="fancyvrb" id="fancyvrb162"> <a 
 id="x15-139020r1"></a>&#x00A0;&#x00A0;astInvert(&#x00A0;frameset&#x00A0;);<br class="fancyvrb" /><a 
 id="x15-139022r2"></a>&#x00A0;&#x00A0;astSet(&#x00A0;frameset,&#x00A0;&#x0022;System=Galactic&#x0022;&#x00A0;);<br class="fancyvrb" /><a 
 id="x15-139024r3"></a>&#x00A0;&#x00A0;astInvert(&#x00A0;frameset&#x00A0;);</div>
<!--l. 7449--><p class="noindent" >The FrameSet would then convert between galactic and ecliptic coordinates.
<!--l. 7452--><p class="noindent" >Note that astSet is not the only function which has this effect: <a 
href="sun211ss21.html#x46-2380000">astClear</a> behaves similarly, as also does
<a 
href="sun211ss137.html#x162-3540000">astPermAxes</a> (&#x00A7;<a 
href="sun211se7.html#x8-820009">7.9<!--tex4ht:ref: ss:permutingaxes --></a>). If you need to circumvent this mechanism for any reason, this can be done by
going behind the scenes and obtaining a pointer directly to the Frame you wish to modify. Consider
the following, for example:
                                                                                       

                                                                                       
<div class="fancyvrb" id="fancyvrb163"> <a 
 id="x15-139026r1"></a>&#x00A0;&#x00A0;skyframe&#x00A0;=&#x00A0;astGetFrame(&#x00A0;frameset,&#x00A0;AST__CURRENT&#x00A0;);<br class="fancyvrb" /><a 
 id="x15-139028r2"></a>&#x00A0;&#x00A0;astSet(&#x00A0;skyframe,&#x00A0;&#x0022;Equinox=J2010&#x0022;&#x00A0;);
<br class="fancyvrb" /><a 
 id="x15-139030r3"></a>&#x00A0;&#x00A0;skyframe&#x00A0;=&#x00A0;astAnnul(&#x00A0;skyframe&#x00A0;);</div>
<!--l. 7467--><p class="noindent" >Here, astSet is applied to the SkyFrame pointer rather than the FrameSet pointer, so the usual checks
on FrameSet integrity do not occur. The SkyFrame&#x2019;s Equinox attribute will therefore be modified
without any corresponding change to the FrameSet&#x2019;s Mappings. In this case you must take
responsibility yourself for maintaining the FrameSet&#x2019;s integrity, perhaps through appropriate use of
astRemapFrame.
<a 
 id="x15-139031r155"></a>
<h4 class="subsectionHead"><span class="titlemark">14.7    </span> <a 
 id="x15-1400007"></a>Merging FrameSets</h4>
<!--l. 7477--><p class="noindent" >As well as adding individual Frames to a <a 
href="sun211ss453.html#x480-6720000">FrameSet</a> (&#x00A7;<a 
href="sun211se13.html#x14-1250003">13.3<!--tex4ht:ref: ss:addingframes --></a>), it is also possible to add complete sets of
inter-related Frames which are contained within another FrameSet. This, of course, corresponds to the
process of merging two FrameSets (Figure&#x00A0;<a 
href="#x15-14000115">15<!--tex4ht:ref: fig:fsmerge --></a>). <hr class="figure"><div class="figure" 
>
                                                                                       

                                                                                       
<a 
 id="x15-14000115"></a>
                                                                                       

                                                                                       
<div class="center">
<img 
src="sun211_figures/fsmerge.png" alt="pdfpict"  
 width="70%" >
<br /> <div class="caption" 
><span class="id">Figure&#x00A0;15: </span><span  
class="content">Two FrameSets in the process of being merged using <a 
href="sun211ss3.html#x28-2200000">astAddFrame</a>. FrameSet&#x00A0;B
is being added to FrameSet&#x00A0;A by supplying a new <a 
href="sun211ss459.html#x486-6780000">Mapping</a> which inter-relates a nominated
<a 
href="sun211ss452.html#x479-6710000">Frame</a> in A (here number&#x00A0;1) and the current Frame of B. In the merged FrameSet, the Frames
contributed by B will be re-numbered to become Frames&#x00A0;4, 5 and 6. The base Frame will remain
unchanged, but the current Frame of B becomes the new current Frame. Note that FrameSet&#x00A0;B
itself is not altered by this process.</span></div><!--tex4ht:label?: x15-14000115 -->
</div>
                                                                                       

                                                                                       
<!--l. 7495--><p class="noindent" ></div><hr class="endfigure">
<!--l. 7499--><p class="noindent" >This process is performed by adding one FrameSet to another using astAddFrame, in much the same
manner as when adding a new Frame to an existing FrameSet (&#x00A7;<a 
href="sun211se13.html#x14-1250003">13.3<!--tex4ht:ref: ss:addingframes --></a>). It is simply a matter of
providing a FrameSet pointer, instead of a Frame pointer, for the 4th argument. In performing the
merger you must, as usual, supply a Mapping, but in this case the Mapping should relate the current
Frame of the FrameSet being added to one of the Frames already present. For example, you might
perform the merger shown in Figure&#x00A0;<a 
href="#x15-14000115">15<!--tex4ht:ref: fig:fsmerge --></a> as follows:
<div class="fancyvrb" id="fancyvrb164"> <a 
 id="x15-140003r1"></a>&#x00A0;&#x00A0;AstMapping&#x00A0;*mapping;<br class="fancyvrb" /><a 
 id="x15-140005r2"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x15-140007r3"></a>&#x00A0;&#x00A0;...<br class="fancyvrb" /><a 
 id="x15-140009r4"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x15-140011r5"></a>&#x00A0;&#x00A0;astAddFrame(&#x00A0;frameseta,&#x00A0;1,&#x00A0;mapping,&#x00A0;framesetb&#x00A0;);</div>
<!--l. 7519--><p class="noindent" >The Frames acquired by &#x201C;frameseta&#x201D; from the FrameSet being added (&#x201C;framesetb&#x201D;) are re-numbered
so that they retain their original order and follow on consecutively after the Frames that were
already present, whose indices remain unchanged. The base Frame of &#x201C;frameseta&#x201D; remains
unchanged, but the current Frame of &#x201C;framesetb&#x201D; becomes its new current Frame. All the
inter-relationships between Frames in both FrameSets remain in place and are preserved in the
merged FrameSet.
<!--l. 7528--><p class="noindent" >Note that while this process modifies the first FrameSet (&#x201C;frameseta&#x201D;), it leaves the original contents of
the one being added (&#x201C;framesetb&#x201D;) unchanged.
                                                                                       

                                                                                       
<!--l. 7535--><p class="noindent" >
                                                                                       

                                                                                       
                                                                                       

                                                                                       
<div class="footnotes"><!--l. 7086--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn22x0-bk" id="fn22x0"><sup class="textsuperscript">22</sup></a></span>If you find that how this ambiguity is resolved actually makes a difference to the conversion that results, then
you have probably constructed a FrameSet which lacks internal self-consistency. For example, you might have two
Frames representing indistinguishable coordinate systems but inter-related by a non-null <a 
href="sun211ss459.html#x486-6780000">Mapping</a>.
<!--l. 7277--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn23x0-bk" id="fn23x0"><sup class="textsuperscript">23</sup></a></span>This is because any transformation to or from this new Frame must go <em>via</em> the base Frame representing the
original data grid coordinate system, which we assume was correctly related to all the other Frames present.     </div> <div class="crosslinks">
<div class="copyright"><span class="pushright">Copyright (C) 2014 Science &#x0026; Technology Facilities Council</span></div> <ul class='nav'> <li class="prev"> <a 
href="sun211se13.html" >&#8592Prev</a>&#x00A0;</li> <li class="title">AST<BR>A Library for Handling<BR>World
Coordinate Systems<BR>in Astronomy</li> <li class="next"><a 
href="sun211se15.html" >Next&#8594</a>&#x00A0;</li> <li class="toc"><a 
href="sun211.html#toc">TOC &#8593</a></li> </ul></div>
<!--l. 7536--><p class="noindent" ><a 
 id="tailsun211se14.html"></a> 
</body> 
</html>