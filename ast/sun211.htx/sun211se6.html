<!DOCTYPE html> 
<html> 
<head><title>Compound Mappings (CmpMaps)</title> 
<meta charset=utf-8/> 
<meta name="generator" content="TeX4ht (http://www.tug.org/tex4ht/)" /> 
<link rel="stylesheet" type="text/css" href="sun211.css" /> 
 <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=MML_HTMLorMML"></script><style type="text/css">.MathJax_MathML {text-indent: 0;}</style></head><body 
>
<div class="crosslinks"><ul class='nav'> <li class="prev"> <a 
href="sun211se5.html" >&#8592Prev</a>&#x00A0;</li> <li class="title">AST<BR>A Library for Handling<BR>World Coordinate Systems<BR>in Astronomy</li> <li class="next"><a 
href="sun211se7.html" >Next&#8594</a>&#x00A0;</li> <li class="toc"><a 
href="sun211.html#toc">TOC &#8593</a></li>
</ul></div>
<h3 class="sectionHead"><span class="titlemark">6    </span> <a 
 id="x7-650006"></a>Compound Mappings (CmpMaps)</h3>
<div class="sectionTOCS">
&#x00A0;<span class="subsectionToc" >6.1 <a 
href="#x7-660001">Combining Mappings in Series</a></span>
<br />&#x00A0;<span class="subsectionToc" >6.2 <a 
href="#x7-670002">Combining Mappings in Parallel</a></span>
<br />&#x00A0;<span class="subsectionToc" >6.3 <a 
href="#x7-680003">The Component Mappings</a></span>
<br />&#x00A0;<span class="subsectionToc" >6.4 <a 
href="#x7-690004">Creating More Complex Mappings</a></span>
<br />&#x00A0;<span class="subsectionToc" >6.5 <a 
href="#x7-700005">Example&#x2014;Transforming Between Two Calibrated Images</a></span>
<br />&#x00A0;<span class="subsectionToc" >6.6 <a 
href="#x7-710006">Over-Complex Compound Mappings</a></span>
<br />&#x00A0;<span class="subsectionToc" >6.7 <a 
href="#x7-720007">Simplifying Compound Mappings</a></span>
</div>
<!--l. 3184--><p class="noindent" >We now turn to a rather special form of <a 
href="sun211ss459.html#x486-6780000">Mapping</a>, the <a 
href="sun211ss444.html#x471-6630000">CmpMap</a>. The Mappings we have considered so
far have been atomic, in the sense that they perform pre-defined elementary transformations. A
CmpMap, however, is a compound Mapping. In essence, it is a framework for containing other
Mappings and its purpose is to allow those Mappings to work together in various combinations while
appearing as a single <a 
href="sun211ss464.html#x491-6830000">Object</a>. A CmpMap&#x2019;s behaviour is therefore not pre-defined, but is determined
by the other Mappings it contains.
<a 
 id="x7-65001r75"></a>
<h4 class="subsectionHead"><span class="titlemark">6.1    </span> <a 
 id="x7-660001"></a>Combining Mappings in Series</h4>
<!--l. 3195--><p class="noindent" >Consider a simple example based on two 2-dimensional coordinate systems. Suppose that to convert from one
to the other we must swap the coordinate order and multiply both coordinates by 5, so that the coordinates
(<!--l. 3198--><math 
 xmlns="http://www.w3.org/1998/Math/MathML"  
display="inline" ><msub><mrow 
><mi 
>x</mi></mrow><mrow 
><mn>1</mn></mrow></msub 
><mo 
class="MathClass-punc">,</mo> <msub><mrow 
><mi 
>x</mi></mrow><mrow 
><mn>2</mn></mrow></msub 
></math>) transform
into (<!--l. 3198--><math 
 xmlns="http://www.w3.org/1998/Math/MathML"  
display="inline" ><mn>5</mn><msub><mrow 
><mi 
>x</mi></mrow><mrow 
><mn>2</mn></mrow></msub 
><mo 
class="MathClass-punc">,</mo> <mn>5</mn><msub><mrow 
><mi 
>x</mi></mrow><mrow 
><mn>1</mn></mrow></msub 
></math>).
This can be done in two stages:
     <dl class="enumerate-enumitem"><dt class="enumerate-enumitem">
  (1) </dt><dd 
class="enumerate-enumitem">Apply a <a 
href="sun211ss466.html#x493-6850000">PermMap</a> (&#x00A7;<a 
href="sun211se5.html#x6-6400011">5.11<!--tex4ht:ref: ss:permmapexample --></a>) to swap the coordinate order.
     </dd><dt class="enumerate-enumitem">
  (2) </dt><dd 
class="enumerate-enumitem">Apply a <a 
href="sun211ss500.html#x527-7190000">ZoomMap</a> (&#x00A7;<a 
href="sun211se4.html#x5-420008">4.8<!--tex4ht:ref: ss:transforming --></a>) to multiply both coordinate values by the constant 5.</dd></dl>
                                                                                       

                                                                                       
<!--l. 3209--><p class="noindent" >The PermMap and ZoomMap are then said to operate <em>in series</em>, because they are applied
sequentially (<em>c.f.</em>&#x00A0;Figure&#x00A0;<a 
href="sun211se2.html#x3-100012">2<!--tex4ht:ref: fig:seriescmpmap --></a>). We can create a <a 
href="sun211ss444.html#x471-6630000">CmpMap</a> that applies these Mappings in series as
follows:
<div class="fancyvrb" id="fancyvrb78"> <a 
 id="x7-66004r1"></a>&#x00A0;&#x00A0;#include&#x00A0;&#x0022;ast.h&#x0022;<br class="fancyvrb" /><a 
 id="x7-66006r2"></a>&#x00A0;&#x00A0;AstCmpMap&#x00A0;*cmpmap;<br class="fancyvrb" /><a 
 id="x7-66008r3"></a>&#x00A0;&#x00A0;AstPermMap&#x00A0;*permmap;<br class="fancyvrb" /><a 
 id="x7-66010r4"></a>&#x00A0;&#x00A0;AstZoomMap&#x00A0;*zoommap;<br class="fancyvrb" /><a 
 id="x7-66012r5"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x7-66014r6"></a>&#x00A0;&#x00A0;...<br class="fancyvrb" /><a 
 id="x7-66016r7"></a>&#x00A0;&#x00A0;
<br class="fancyvrb" /><a 
 id="x7-66018r8"></a>&#x00A0;&#x00A0;/*&#x00A0;Create&#x00A0;the&#x00A0;individual&#x00A0;Mappings.&#x00A0;*/<br class="fancyvrb" /><a 
 id="x7-66020r9"></a>&#x00A0;&#x00A0;{<br class="fancyvrb" /><a 
 id="x7-66022r10"></a>&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;int&#x00A0;inperm[&#x00A0;2&#x00A0;]&#x00A0;=&#x00A0;{&#x00A0;2,&#x00A0;1&#x00A0;};<br class="fancyvrb" /><a 
 id="x7-66024r11"></a>&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;int&#x00A0;outperm[&#x00A0;2&#x00A0;]&#x00A0;=&#x00A0;{&#x00A0;2,&#x00A0;1&#x00A0;};
<br class="fancyvrb" /><a 
 id="x7-66026r12"></a>&#x00A0;&#x00A0;&#x00A0;&#x00A0;&#x00A0;permmap&#x00A0;=&#x00A0;astPermMap(&#x00A0;2,&#x00A0;inperm,&#x00A0;2,&#x00A0;outperm,&#x00A0;NULL,&#x00A0;&#x0022;&#x0022;&#x00A0;);<br class="fancyvrb" /><a 
 id="x7-66028r13"></a>&#x00A0;&#x00A0;}<br class="fancyvrb" /><a 
 id="x7-66030r14"></a>&#x00A0;&#x00A0;zoommap&#x00A0;=&#x00A0;astZoomMap(&#x00A0;2,&#x00A0;5.0,&#x00A0;&#x0022;&#x0022;&#x00A0;)
<br class="fancyvrb" /><a 
 id="x7-66032r15"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x7-66034r16"></a>&#x00A0;&#x00A0;/*&#x00A0;Combine&#x00A0;them&#x00A0;in&#x00A0;series.&#x00A0;*/<br class="fancyvrb" /><a 
 id="x7-66036r17"></a>&#x00A0;&#x00A0;cmpmap&#x00A0;=&#x00A0;astCmpMap(&#x00A0;permmap,&#x00A0;zoommap,&#x00A0;1,&#x00A0;&#x0022;&#x0022;&#x00A0;);<br class="fancyvrb" /><a 
 id="x7-66038r18"></a>&#x00A0;&#x00A0;
<br class="fancyvrb" /><a 
 id="x7-66040r19"></a>&#x00A0;&#x00A0;/*&#x00A0;Annul&#x00A0;the&#x00A0;individual&#x00A0;Mapping&#x00A0;pointers.&#x00A0;*/<br class="fancyvrb" /><a 
 id="x7-66042r20"></a>&#x00A0;&#x00A0;permmap&#x00A0;=&#x00A0;astAnnul(&#x00A0;permmap&#x00A0;);<br class="fancyvrb" /><a 
 id="x7-66044r21"></a>&#x00A0;&#x00A0;zoommap&#x00A0;=&#x00A0;astAnnul(&#x00A0;zoommap&#x00A0;);</div>
<!--l. 3240--><p class="noindent" >Here, the third argument (1) of the constructor function <a 
href="sun211ss26.html#x51-2430000">astCmpMap</a> indicates &#x201C;in series&#x201D;.
<!--l. 3243--><p class="noindent" >When used to transform coordinates in the forward direction, the resulting CmpMap will apply the
first component <a 
href="sun211ss459.html#x486-6780000">Mapping</a> (the PermMap) and then the second one (the ZoomMap). When
transforming in the inverse direction, it will apply the second one (in the inverse direction) and then
the first one (also in the inverse direction). In general, although not in this particular example, the
order in which the two component Mappings are supplied is significant. Clearly, also, the <a 
href="sun211ss359.html#x385-5770000">Nout</a>
attribute (number of output coordinates) for the first Mapping must equal the <a 
href="sun211ss353.html#x379-5710000">Nin</a> attribute (number
of input coordinates) for the second one.
<a 
 id="x7-66045r77"></a>
<h4 class="subsectionHead"><span class="titlemark">6.2    </span> <a 
 id="x7-670002"></a>Combining Mappings in Parallel</h4>
<!--l. 3256--><p class="noindent" >Connecting two Mappings in series (&#x00A7;<a 
href="#x7-660001">6.1<!--tex4ht:ref: ss:seriescmpmap --></a>) is not the only way of combining them. The alternative, <em>in
parallel</em>, involves applying the two Mappings at once but on different subsets of the coordinate
values.
<!--l. 3261--><p class="noindent" >Consider, for example, a set of 3-dimensional coordinates and suppose we wish to transform them
by swapping the first two coordinate values and multiplying the final one by 5, so that
(<!--l. 3263--><math 
 xmlns="http://www.w3.org/1998/Math/MathML"  
display="inline" ><msub><mrow 
><mi 
>x</mi></mrow><mrow 
><mn>1</mn></mrow></msub 
><mo 
class="MathClass-punc">,</mo> <msub><mrow 
><mi 
>x</mi></mrow><mrow 
><mn>2</mn></mrow></msub 
><mo 
class="MathClass-punc">,</mo> <msub><mrow 
><mi 
>x</mi></mrow><mrow 
><mn>3</mn></mrow></msub 
></math>) transforms
into (<!--l. 3264--><math 
 xmlns="http://www.w3.org/1998/Math/MathML"  
display="inline" ><msub><mrow 
><mi 
>x</mi></mrow><mrow 
><mn>2</mn></mrow></msub 
><mo 
class="MathClass-punc">,</mo> <msub><mrow 
><mi 
>x</mi></mrow><mrow 
><mn>1</mn></mrow></msub 
><mo 
class="MathClass-punc">,</mo> <mn>5</mn><msub><mrow 
><mi 
>x</mi></mrow><mrow 
><mn>3</mn></mrow></msub 
></math>).
Again, we can perform each of these steps individually using Mappings similar to the <a 
href="sun211ss466.html#x493-6850000">PermMap</a> and
<a 
href="sun211ss500.html#x527-7190000">ZoomMap</a> used earlier (&#x00A7;<a 
href="#x7-660001">6.1<!--tex4ht:ref: ss:seriescmpmap --></a>). In this case, however, the ZoomMap is 1-dimensional and the
individual Mappings are applied in parallel (<em>c.f.</em>&#x00A0;Figure&#x00A0;<a 
href="sun211se2.html#x3-100023">3<!--tex4ht:ref: fig:parallelcmpmap --></a>).
<!--l. 3270--><p class="noindent" >Creating a <a 
href="sun211ss444.html#x471-6630000">CmpMap</a> for this purpose is also very simple:
<div class="fancyvrb" id="fancyvrb79"> <a 
 id="x7-67002r1"></a>&#x00A0;&#x00A0;cmpmap&#x00A0;=&#x00A0;astCmpMap(&#x00A0;permmap,&#x00A0;zoommap,&#x00A0;0,&#x00A0;&#x0022;&#x0022;&#x00A0;);</div>
<!--l. 3278--><p class="noindent" >The only difference is that the third argument of <a 
href="sun211ss26.html#x51-2430000">astCmpMap</a> is now zero, meaning &#x201C;in
parallel&#x201D;.
<!--l. 3281--><p class="noindent" >As before, the order in which the two component Mappings are supplied is significant. The first
one acts on the lower-numbered input coordinate values (however many it needs) and
produces the lower-numbered output coordinates, while the second <a 
href="sun211ss459.html#x486-6780000">Mapping</a> acts on the
higher-numbered input coordinates (however many remain) and generates the remaining
higher-numbered output coordinates. When the CmpMap transforms coordinates in the inverse
direction, both component Mappings are applied to the same coordinates, but in the inverse
direction.
                                                                                       

                                                                                       
<!--l. 3291--><p class="noindent" >Note that the <a 
href="sun211ss353.html#x379-5710000">Nin</a> and <a 
href="sun211ss359.html#x385-5770000">Nout</a> attributes of the component Mappings (<em>i.e.</em>&#x00A0;the numbers of
input and output coordinates) will sum to give the Nin and Nout attributes of the overall
CmpMap.
<a 
 id="x7-67003r78"></a>
<h4 class="subsectionHead"><span class="titlemark">6.3    </span> <a 
 id="x7-680003"></a>The Component Mappings</h4>
<!--l. 3297--><p class="noindent" >A <a 
href="sun211ss444.html#x471-6630000">CmpMap</a> does not store copies of its component Mappings, but simply holds pointers to them. In
the example above (&#x00A7;<a 
href="#x7-660001">6.1<!--tex4ht:ref: ss:seriescmpmap --></a>), we were free to annul the individual <a 
href="sun211ss459.html#x486-6780000">Mapping</a> pointers after creating the
CmpMap because the pointers held internally by the CmpMap increased the reference count
(<a 
href="sun211ss377.html#x403-5950000">RefCount</a> attribute) of each component Mapping by one. The individual components are therefore
not deleted by <a 
href="sun211ss7.html#x32-2240000">astAnnul</a>, but retained until the CmpMap itself is deleted and annuls the pointers it
holds. Consistent use of astAnnul (&#x00A7;<a 
href="sun211se4.html#x5-430009">4.9<!--tex4ht:ref: ss:annullingpointers --></a>) and/or pointer contexts (&#x00A7;<a 
href="sun211se4.html#x5-4400010">4.10<!--tex4ht:ref: ss:contexts --></a>) will therefore ensure that all
Objects are deleted at the appropriate time.
<!--l. 3309--><p class="noindent" >Note that access to a CmpMap&#x2019;s component Mappings is not generally available unless pointers to
them are retained when the CmpMap is created. If such pointers are retained, then subsequent
modifications to the individual components can be used to indirectly modify the behaviour of the
overall CmpMap.
<!--l. 3315--><p class="noindent" >There is an important exception to this, however, because a CmpMap retains a copy of the initial
<a 
href="sun211ss312.html#x338-5300000">Invert</a> flag settings of each of its components and uses these in order to ignore any subsequent
external changes. This means that you may invert either component Mapping before inserting it into a
CmpMap and need not worry if you un-invert it again later. The CmpMap&#x2019;s behaviour will not be
affected by the later action.
<a 
 id="x7-68001r79"></a>
<h4 class="subsectionHead"><span class="titlemark">6.4    </span> <a 
 id="x7-690004"></a>Creating More Complex Mappings</h4>
<!--l. 3325--><p class="noindent" >Because a <a 
href="sun211ss444.html#x471-6630000">CmpMap</a> is itself a <a 
href="sun211ss459.html#x486-6780000">Mapping</a>, any existing CmpMap can substitute (&#x00A7;<a 
href="sun211se4.html#x5-370003">4.3<!--tex4ht:ref: ss:objecthierarchy --></a>) as a component
Mapping when constructing a new CmpMap using <a 
href="sun211ss26.html#x51-2430000">astCmpMap</a>. This has the effect of nesting one
CmpMap inside another and opens up many new possibilities. For example, combining three
Mappings in series can be accomplished as follows:
<div class="fancyvrb" id="fancyvrb80"> <a 
 id="x7-69002r1"></a>&#x00A0;&#x00A0;AstMapping&#x00A0;*map1,&#x00A0;*map2,&#x00A0;*map3;<br class="fancyvrb" /><a 
 id="x7-69004r2"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x7-69006r3"></a>&#x00A0;&#x00A0;...<br class="fancyvrb" /><a 
 id="x7-69008r4"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x7-69010r5"></a>&#x00A0;&#x00A0;cmpmap&#x00A0;=&#x00A0;astCmpMap(&#x00A0;map1,&#x00A0;astCmpMap(&#x00A0;map2,&#x00A0;map3,&#x00A0;1,&#x00A0;&#x0022;&#x0022;&#x00A0;),&#x00A0;1,&#x00A0;&#x0022;&#x0022;&#x00A0;);</div>
<!--l. 3342--><p class="noindent" >The way in which the individual component Mappings are grouped within the nested CmpMaps is
not usually important.
<!--l. 3345--><p class="noindent" >A similar technique can be used to combine multiple Mappings in parallel and, of course, mixed series
and parallel combinations are also possible (Figure&#x00A0;<a 
href="sun211se2.html#x3-100044">4<!--tex4ht:ref: fig:complexcmpmap --></a>). There is no built-in limit to how many
CmpMaps may be nested in this way, so this mechanism provides an indefinitely extensible
method of building complex Mappings out of the elemental building blocks provided by
AST.
<!--l. 3352--><p class="noindent" >In practice, you might not need to construct such complex CmpMaps yourself very frequently, but
they will often be returned by AST routines. Nested CmpMaps underlie the library&#x2019;s entire ability to
represent a wide range of different coordinate transformations.
<a 
 id="x7-69011r80"></a>
                                                                                       

                                                                                       
<h4 class="subsectionHead"><span class="titlemark">6.5    </span> <a 
 id="x7-700005"></a>Example&#x2014;Transforming Between Two Calibrated Images</h4>
<!--l. 3359--><p class="noindent" >Consider, as a practical example of CmpMaps, two images of the sky. Suppose that for each image we
have a <a 
href="sun211ss459.html#x486-6780000">Mapping</a> which converts from pixel coordinates to a standard celestial coordinate system, say
FK5&#x00A0;(J2000.0). If we wish to inter-compare these images, we can do so by using this celestial
coordinate system to align them. That is, we first convert from pixel coordinates in the first image into
FK5 coordinates and we then convert from FK5 coordinates into pixel coordinates in the second
image.
<!--l. 3368--><p class="noindent" >If &#x201C;mapa&#x201D; and &#x201C;mapb&#x201D; are pointers to our two original Mappings, we could form a <a 
href="sun211ss444.html#x471-6630000">CmpMap</a> which
transforms directly between the pixel coordinates of the first and second images by combining these
Mappings, as follows:
<div class="fancyvrb" id="fancyvrb81"> <a 
 id="x7-70002r1"></a>&#x00A0;&#x00A0;AstCmpMap&#x00A0;*alignmap;<br class="fancyvrb" /><a 
 id="x7-70004r2"></a>&#x00A0;&#x00A0;AstMapping&#x00A0;*mapa,&#x00A0;*mapb;<br class="fancyvrb" /><a 
 id="x7-70006r3"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x7-70008r4"></a>&#x00A0;&#x00A0;...<br class="fancyvrb" /><a 
 id="x7-70010r5"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x7-70012r6"></a>&#x00A0;&#x00A0;astInvert(&#x00A0;mapb&#x00A0;);
<br class="fancyvrb" /><a 
 id="x7-70014r7"></a>&#x00A0;&#x00A0;alignmap&#x00A0;=&#x00A0;astCmpMap(&#x00A0;mapa,&#x00A0;mapb,&#x00A0;1,&#x00A0;&#x0022;&#x0022;&#x00A0;);<br class="fancyvrb" /><a 
 id="x7-70016r8"></a>&#x00A0;&#x00A0;astInvert(&#x00A0;mapb&#x00A0;);</div>
<!--l. 3386--><p class="noindent" >Here, we have used <a 
href="sun211ss94.html#x119-3110000">astInvert</a> (&#x00A7;<a 
href="sun211se5.html#x6-590006">5.6<!--tex4ht:ref: ss:invertingmappings --></a>) to invert &#x201C;mapb&#x201D; before inserting it into the CmpMap
because, as supplied, it converted in the wrong direction. Afterwards, we invert it again to
return it to its original state. The CmpMap, however, will ignore this subsequent change
(&#x00A7;<a 
href="#x7-680003">6.3<!--tex4ht:ref: ss:cmpmapcomponents --></a>).
<!--l. 3392--><p class="noindent" >The forward transformation of the resulting CmpMap will now transform from pixel coordinates in
the first image to pixel coordinates in the second image, while its inverse transformation will convert
in the opposite direction.
<a 
 id="x7-70017r81"></a>
<h4 class="subsectionHead"><span class="titlemark">6.6    </span> <a 
 id="x7-710006"></a>Over-Complex Compound Mappings</h4>
<!--l. 3399--><p class="noindent" >While a <a 
href="sun211ss444.html#x471-6630000">CmpMap</a> provides a very flexible way of constructing arbitrarily complex Mappings (&#x00A7;<a 
href="#x7-690004">6.4<!--tex4ht:ref: ss:complexcmpmap --></a>), it
unfortunately also provides an opportunity for representing simple Mappings in complex ways.
Sometimes, unnecessary complexity can be difficult to avoid but can obscure important
simplifications.
<!--l. 3405--><p class="noindent" >Consider the example above (&#x00A7;<a 
href="#x7-700005">6.5<!--tex4ht:ref: ss:cmpmapexample --></a>), in which we inter-related two images of the sky <em>via</em> a
CmpMap. If the two images turned out to be simply offset from each other by a shift along each
pixel axis, then this approach would align them correctly, but it would be inefficient. This
is because it would introduce unnecessary and expensive transformations to and from
an intermediate celestial coordinate system, whereas a simple shift of pixel origin would
suffice.
<!--l. 3414--><p class="noindent" >Recognising that a simpler and more efficient solution exists obviously requires a little more than
simply joining two Mappings end-to-end. We must also determine whether the resulting CmpMap is
more complex than it needs to be, <em>i.e.</em>&#x00A0;contains redundant information. If it is, we then need a way to
simplify it.
<!--l. 3420--><p class="noindent" >The problem is not always just one of efficiency, however. Sometimes we may also need to know
something about the actual form a <a 
href="sun211ss459.html#x486-6780000">Mapping</a> takes&#x2014;<em>i.e.</em>&#x00A0;the nature of the operations it performs.
Unnecessary complexity can obscure this, but such complexity can easily accumulate during normal
data processing.
                                                                                       

                                                                                       
<!--l. 3426--><p class="noindent" >For example, a Mapping that transforms pixel coordinates into positions on the sky might be
repeatedly modified as changes are made to the shape and size of the image. Typically, on each
occasion, another Mapping will be concatenated to reflect what has happened to the image. This
could soon make it difficult to discern the overall nature of the transformation from the
complex CmpMap that accumulates. If only shifts of origin were involved on each occasion,
however, they could be combined into a single shift which could be represented much more
simply.
<!--l. 3436--><p class="noindent" >Suppose we now wanted to represent our image&#x2019;s celestial coordinate calibration using FITS
conventions (&#x00A7;<a 
href="sun211se17.html#x18-17200017">17<!--tex4ht:ref: ss:foreignfits --></a>). This requires AST to determine whether the Mapping which relates pixel
coordinate to sky positions conforms to the FITS model (for example, whether it is equivalent to
applying a single set of shifts and scale factors followed by a map projection). Clearly,
there is an important use here for some means of simplifying the internal structure of a
CmpMap.
<a 
 id="x7-71001r82"></a>
<h4 class="subsectionHead"><span class="titlemark">6.7    </span> <a 
 id="x7-720007"></a>Simplifying Compound Mappings</h4>
<!--l. 3447--><p class="noindent" >The ability to simplify compound Mappings is provided by the <a 
href="sun211ss190.html#x215-4070000">astSimplify</a> function. This function
encapsulates a number of heuristics for converting Mappings, or combinations of Mappings within a
<a 
href="sun211ss444.html#x471-6630000">CmpMap</a>, into simpler, equivalent ones. When applied to a CmpMap, astSimplify tries to reduce the
number of individual Mappings within it by merging neighbouring component Mappings together. It
will do this with both series and parallel combinations of Mappings, or both, and will handle
CmpMaps nested to any depth (&#x00A7;<a 
href="#x7-690004">6.4<!--tex4ht:ref: ss:complexcmpmap --></a>).
<!--l. 3457--><p class="noindent" >To illustrate how astSimplify works, consider the combination of Mappings shown in Figure&#x00A0;<a 
href="#x7-7200110">10<!--tex4ht:ref: fig:simplifyexample --></a>.
<hr class="figure"><div class="figure" 
>
                                                                                       

                                                                                       
<a 
 id="x7-7200110"></a>
                                                                                       

                                                                                       
<div class="center">
<img 
src="sun211_figures/simpexamp.png" alt="pdfpict"  
 width="70%" >
<br /> <div class="caption" 
><span class="id">Figure&#x00A0;10: </span><span  
class="content">An over-complex compound Mapping, consisting of PermMaps, ZoomMaps and
a  <a 
href="sun211ss495.html#x522-7140000">UnitMap</a>,  which  can  be  simplified  to  become  a  single  UnitMap.  The  enclosing  nested
CmpMaps have been omitted for clarity.</span></div><!--tex4ht:label?: x7-7200110 -->
</div>
                                                                                       

                                                                                       
<!--l. 3467--><p class="noindent" ></div><hr class="endfigure">
<!--l. 3469--><p class="noindent" >If this were contained in a CmpMap, it could be simplified as follows:
<div class="fancyvrb" id="fancyvrb82"> <a 
 id="x7-72003r1"></a>&#x00A0;&#x00A0;AstMapping&#x00A0;*simpler;<br class="fancyvrb" /><a 
 id="x7-72005r2"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x7-72007r3"></a>&#x00A0;&#x00A0;...<br class="fancyvrb" /><a 
 id="x7-72009r4"></a>&#x00A0;&#x00A0;<br class="fancyvrb" /><a 
 id="x7-72011r5"></a>&#x00A0;&#x00A0;simpler&#x00A0;=&#x00A0;astSimplify(&#x00A0;cmpmap&#x00A0;);</div>
<!--l. 3481--><p class="noindent" >In this case, the result would be a simple 3-dimensional UnitMap (the identity <a 
href="sun211ss459.html#x486-6780000">Mapping</a>). To
reach this conclusion, astSimplify will have made a number of deductions, roughly as
follows:
     <dl class="enumerate-enumitem"><dt class="enumerate-enumitem">
  (1) </dt><dd 
class="enumerate-enumitem">The two 2-dimensional ZoomMaps in series are equivalent to a single <a 
href="sun211ss500.html#x527-7190000">ZoomMap</a> with a
     combined <a 
href="sun211ss438.html#x464-6560000">Zoom</a> factor of unity. This, in turn, is equivalent to a 2-dimensional UnitMap.
     </dd><dt class="enumerate-enumitem">
  (2) </dt><dd 
class="enumerate-enumitem">This  UnitMap  in  parallel  with  the  other  1-dimensional  UnitMap  is  equivalent  to  a
     single  3-dimensional  UnitMap.  This  UnitMap,  sandwiched  between  any  other  pair  of
     Mappings, can then be eliminated.
     </dd><dt class="enumerate-enumitem">
  (3) </dt><dd 
class="enumerate-enumitem">The  remaining  two  PermMaps  in  series  are  equivalent  to  a  single  3-dimensional
     <a 
href="sun211ss466.html#x493-6850000">PermMap</a>. When these are combined, the resulting PermMap is found to be equivalent to
     a 3-dimensional UnitMap.</dd></dl>
<!--l. 3499--><p class="noindent" >This example is a little contrived, but illustrates how astSimplify can deal with even quite complicated
compound Mappings through a series of incremental simplifications. Where possible, this will result
in either a simpler compound Mapping or, if feasible, an atomic (non-compound) Mapping, as
here. If no simplification is possible, astSimplify will just return a pointer to the original
Mapping.
<!--l. 3506--><p class="noindent" >Although astSimplify cannot identify every simplification that is theoretically possible, sufficient rules
are included to deal with the most common and important cases.
                                                                                       

                                                                                       
<!--l. 3510--><p class="noindent" >
                                                                                       

                                                                                       
                                                                                       

                                                                                       
<div class="crosslinks"> <div class="copyright"><span class="pushright">Copyright (C) 2014 Science &#x0026; Technology Facilities Council</span></div> <ul class='nav'> <li class="prev"> <a 
href="sun211se5.html" >&#8592Prev</a>&#x00A0;</li> <li class="title">AST<BR>A Library for Handling<BR>World
Coordinate Systems<BR>in Astronomy</li> <li class="next"><a 
href="sun211se7.html" >Next&#8594</a>&#x00A0;</li> <li class="toc"><a 
href="sun211.html#toc">TOC &#8593</a></li> </ul></div>
<!--l. 3511--><p class="noindent" ><a 
 id="tailsun211se6.html"></a> 
</body> 
</html>