include ../../make.pkgs

TCL_LIB_SPEC	= @TCL_LIB_SPEC@
TCL_STUB_LIB_SPEC= @TCL_STUB_LIB_SPEC@
TK_LIBS		= @TK_LIBS@
TK_LIB_SPEC	= @TK_LIB_SPEC@
TK_STUB_LIB_SPEC= @TK_STUB_LIB_SPEC@

CC		= @CC@
CFLAGS_DEFAULT	= @CFLAGS_DEFAULT@
CFLAGS_WARNING	= @CFLAGS_WARNING@
EXEEXT		= @EXEEXT@
OBJEXT		= @OBJEXT@

INCLUDES	= @PKG_INCLUDES@ @TCL_INCLUDES@ @TK_INCLUDES@ @TK_XINCLUDES@

PKG_CFLAGS	= @PKG_CFLAGS@
DEFS		= @DEFS@ $(PKG_CFLAGS)

CPPFLAGS	= @CPPFLAGS@
LIBS		= @PKG_LIBS@ @LIBS@
CFLAGS		= @CFLAGS@
COMPILE		= $(CC) $(DEFS) $(INCLUDES) $(CPPFLAGS) $(CFLAGS)

.SUFFIXES: .c .C .$(OBJEXT)

.c.@OBJEXT@:
	$(COMPILE) -c $< -o $@

.C.@OBJEXT@:
	$(COMPILE) -c $< -o $@

#--------------------------defines

ID	= $(shell finger $(shell whoami) | egrep -o 'Name: [a-zA-Z0-9 ]{1,}' | cut -d ':' -f 2 | xargs echo)

OBJS	= ds9.o tkAppInit.o

LLIBS	= \
	../../lib/tksao$(TKSAOVER)/libtksao$(TKSAOVER).a \
	../../lib/libfuntools.a \
	../../lib/libast.a \
	../../lib/libast_err.a \
	../../lib/libast_pal.a \
	../../lib/tksao$(TKSAOVER)/libtksao$(TKSAOVER).a \
	../../lib/tkhtml1$(TKHTMLVER)/libtkhtml1$(TKHTMLVER).a \
	../../lib/tkmpeg$(TKMPEGVER)/libtkmpeg$(TKMPEGVER).a \
	../../lib/Tclxml$(TCLXMLVER)/libTclxml$(TCLXMLVER).a \
	../../lib/Tktable$(TKTABLEVER)/libTktable$(TKTABLEVER).a \
	../../lib/Img$(TKIMGVER)/libtkimgpng1.4.2.a \
	../../lib/Img$(TKIMGVER)/libpngtcl1.4.12.a \
	../../lib/Img$(TKIMGVER)/libtkimgtiff1.4.2.a \
	../../lib/Img$(TKIMGVER)/libtifftcl3.9.4.a \
	../../lib/Img$(TKIMGVER)/libtkimgjpeg1.4.2.a \
	../../lib/Img$(TKIMGVER)/libjpegtcl8.4.a \
	../../lib/Img$(TKIMGVER)/libtkimggif1.4.2.a \
	../../lib/Img$(TKIMGVER)/libtkimgwindow1.4.2.a \
	../../lib/Img$(TKIMGVER)/libzlibtcl1.2.8.a \
	../../lib/Img$(TKIMGVER)/libtkimg1.4.2.a \
	../../lib/libxpa.a \
	../../lib/tcliis$(TCLIISVER)/libtcliis$(TCLIISVER).a \
	../../lib/tclcheckdns$(TCLCHECKDNSVER)/libtclcheckdns$(TCLCHECKDNSVER).a \
	../../lib/tclsignal$(TCLSIGNALVER)/libtclsignal$(TCLSIGNALVER).a \
	../../lib/tkblt$(TKBLTVER)/libtkbltstub$(TKBLTVER).a \
	../../lib/tkblt$(TKBLTVER)/libtkblt$(TKBLTVER).a \
	../../lib/tkmacosx$(TKMACOSXVER)/libtkmacosx$(TKMACOSXVER).a

APPDIR	= ../../bin/SAOImage\ DS9.app
TKSAOFW	= ../../bin/SAOImage\ DS9.app/Contents/Frameworks/Tksao.framework
TKSAORES= ../../bin/SAOImage\ DS9.app/Contents/Frameworks/Tksao.framework/Resources
TCLFW	= ../../bin/SAOImage\ DS9.app/Contents/Frameworks/Tcl.framework
TCLRES	= ../../bin/SAOImage\ DS9.app/Contents/Frameworks/Tcl.framework/Resources
TKFW	= ../../bin/SAOImage\ DS9.app/Contents/Frameworks/Tk.framework
TKRES	= ../../bin/SAOImage\ DS9.app/Contents/Frameworks/Tk.framework/Resources

#--------------------------main

.NOTPARALLEL :
.PHONY	: ds9 debug appdir framework tcl tcl_debug tk tk_debug tcllib tkcon
.PHONY	: tkblt xpa compiler cleanup

ds9	: ds9base appdir framework tcl tk tcllib tkcon tkblt xpa compiler cleanup
	cp -p ds9base $(APPDIR)/Contents/MacOS/ds9
	strip $(APPDIR)/Contents/MacOS/ds9
	install_name_tool -change \
	/Library/Frameworks/Tcl.framework/Versions/8.6/Tcl \
	@executable_path/../Frameworks/Tcl.framework/Tcl \
	$(APPDIR)/Contents/MacOS/ds9
	install_name_tool -change \
	/Library/Frameworks/Tk.framework/Versions/8.6/Tk \
	@executable_path/../Frameworks/Tk.framework/Tk \
	$(APPDIR)/Contents/MacOS/ds9
	cd ../../bin; codesign --deep -f -s "$(ID)" SAOImage\ DS9.app

debug	: ds9base appdir framework tcl tk tcllib tkcon tkblt xpa compiler cleanup
	cp -p ds9base $(APPDIR)/Contents/MacOS/ds9
	install_name_tool -change \
	/Library/Frameworks/Tcl.framework/Versions/8.6/Tcl \
	@executable_path/../Frameworks/Tcl.framework/Tcl \
	$(APPDIR)/Contents/MacOS/ds9
	install_name_tool -change \
	/Library/Frameworks/Tk.framework/Versions/8.6/Tk \
	@executable_path/../Frameworks/Tk.framework/Tk \
	$(APPDIR)/Contents/MacOS/ds9
	cd ../../bin; codesign --deep -f -s "$(ID)" SAOImage\ DS9.app

tkAppInit.o : tkAppInit.c
	$(COMPILE) -DTK_LOCAL_APPINIT=SAOAppInit \
	-DTK_LOCAL_MAIN_HOOK=SAOLocalMainHook -c tkAppInit.c -o $@

tkAppInit.c : ../../tk$(TCLVER)/unix/tkAppInit.c
	cp ../../tk$(TCLVER)/unix/tkAppInit.c .

ds9base	: $(OBJS) $(LLIBS)
	$(RM) $@
	$(CC) $(CFLAGS) -o $@ \
	$(OBJS) \
	$(LLIBS) \
	$(LIBS) \
	$(TK_STUB_LIB_SPEC) $(TK_LIB_SPEC) \
	$(TCL_STUB_LIB_SPEC) $(TCL_LIB_SPEC) \
	$(TK_LIBS)

appdir	:
	rm -rf $(APPDIR)
	cp -rp SAOImage\ DS9.app ../../bin/.

framework:
	cp -pr ../library $(TKSAORES)/.
	cp -pr ../msgs $(TKSAORES)/.
	cp -pr ../doc $(TKSAORES)/.
	cp -pr ../cmaps $(TKSAORES)/.
	cp -pr ../template $(TKSAORES)/.

	rm $(TKSAORES)/library/source.tcl
	echo "pkg_mkIndex $(TKSAORES)/library *.tcl; exit" | ../../bin/tclsh8.6

tcl	:
	cp -p ../../build/tcl/Tcl.framework/Versions/8.6/Tcl $(TCLFW)/.
	cp -pr ../../build/tcl/Tcl.framework/Versions/8.6/Resources/* $(TCLRES)/.

tcl_debug:
	cp -p ../../build/tcl/Tcl.framework/Versions/8.6/Tcl_debug $(TCLFW)/Tcl
	cp -pr ../../build/tcl/Tcl.framework/Versions/8.6/Resources/* $(TCLRES)/.

tk	:
	cp -p ../../build/tk/Tk.framework/Versions/8.6/Tk $(TKFW)/.
	cp -p ../../build/tk/Tk.framework/Versions/8.6/Resources/Info.plist \
	$(TKRES)/.
	cp -p ../../build/tk/Tk.framework/Versions/8.6/Resources/license.terms \
	$(TKRES)/.
	cp -rp ../../build/tk/Tk.framework/Versions/8.6/Resources/Scripts \
	$(TKRES)/.

tk_debug:
	cp -p ../../build/tk/Tk.framework/Versions/8.6/Tk_debug $(TKFW)/Tk
	cp -p ../../build/tk/Tk.framework/Versions/8.6/Resources/Info.plist \
	$(TKRES)/.
	cp -p ../../build/tk/Tk.framework/Versions/8.6/Resources/license.terms \
	$(TKRES)/.
	cp -rp ../../build/tk/Tk.framework/Versions/8.6/Resources/Scripts \
	$(TKRES)/.

tcllib	:
	cp -pr ../../tcllib/modules/base64 $(TKSAORES)/.
	cp -pr ../../tcllib/modules/ftp $(TKSAORES)/.
	cp -pr ../../tcllib/modules/log $(TKSAORES)/.
	cp -pr ../../tcllib/modules/textutil $(TKSAORES)/.
	cp -pr ../../tcllib/modules/math $(TKSAORES)/.

tkcon	:
	mkdir $(TKSAORES)/tkcon
	cp -p ../../tkcon/*.tcl $(TKSAORES)/tkcon/.

tkblt	:
	mkdir $(TKSAORES)/tkblt
	cp -p ../../tkblt/library/graph.tcl $(TKSAORES)/tkblt/.
	echo "pkg_mkIndex $(TKSAORES)/tkblt *.tcl; exit" | ../../bin/tclsh8.6

xpa	:
	cp -pr ../../bin/xpans $(TKSAORES)/.

compiler:
	cp -p ../../compilers/pcc-i386-snowleopard.tar.gz $(TKSAORES)/.

cleanup:
	cd $(APPDIR); find . -depth -name CVS -exec rm -rf {} \;
	cd $(APPDIR); find . -name keepme -exec rm -rf {} \;

#--------------------------cleanup

.PHONY	: clean distclean

clean	:
	cd ../library; $(MAKE) clean
	$(RM) core *~ *# ds9Base ds9 *.o

distclean: clean
	-rm -f Makefile config.cache config.log config.status


